#!/bin/bash

shopt -s checkwinsize; (:;:)
# shopt -s dotglob

read_keys(){
  read -rsn1; [[ $REPLY == $'\e' ]]&& read -rsn2
  KEY="${REPLY^^}"
}

status_bar(){
  printf '\e[999H\e[2K\e[1;44;30mFML\e[m%s' "${1:+: $1}"
}

get_files(){
  unset i hist symLinks directories executables plainFiles files
  for _ in *; do
    if [[ -h $_ ]]; then
      symLinks+=("6m$_\e[m")
    elif [[ -d $_ ]]; then
      directories+=("4m$_\e[m")
    elif [[ -x $_|| $_ == *'.sh' ]]; then
      executables+=("2m$_\e[m")
    else
      plainFiles+=("9m$_\e[m")
    fi

    files=("${directories[@]}" "${executables[@]}" "${symLinks[@]}" "${plainFiles[@]}")
  done

  printf '\e[999H\e[3%b\n' "${files[@]}"
}

infinite_boundries(){
  if (( cursor > LINES-1 )); then
    ((cursor=LINES-${#files[@]}))
  elif (( cursor < LINES-${#files[@]} )); then
    ((cursor=LINES-1))
  fi

  printf '\e[%dH' "$cursor"
}

hover_file(){
  hover="${files[cursor-LINES]}"
  hist+=("${cursor}H\e[3${hover}")
  (( i ))&&{
    printf '\e[%b\e[m' "${hist[0]}"
    hist=("${hist[@]:1}")
  }|| i=1

  printf '\e[%dH\e[1;4%b' "$cursor" "$hover"
}

file_keymap(){
  for((;;)){
    read_keys
    case $KEY in
      H|\[D) printf '\e[?1049l\e[2J'; get_files; status_bar; break;;
      L|\[C) "${EDITOR:-${VISUAL:-vim}}" "$selected"
    esac
  }
}

main_keymap(){
  read_keys
  case $KEY in
    Q) printf '\e[?1049l'; exit;;
    H|\[D) cd ../; printf '\e[2J'; get_files; status_bar;;
    J|\[B) ((cursor++));;
    K|\[A) ((cursor--));;
    L|\[C) selected="${files[cursor-LINES]#*[0-9]m}" selected="${selected%\\e*}"
      status_bar "$selected"
      if [[ -d "$selected" ]]; then
        cd "$selected"; printf '\e[2J'; get_files; status_bar "$selected"
      elif [[ -f "$selected" ]]; then
        printf '\e[?1049l\e[2J\e[999H'
        cat "$selected"
        status_bar "$selected"

        file_keymap
      fi
    ;;
  esac
}

printf '\e[?1049h\e[2J\e[?25l\e[999H'

get_files; status_bar
for((;;)){ main_keymap; infinite_boundries; hover_file; }